.PAG 'CLOSE  2/15/83'
;*************************************
;* NCLOSE -- CLOSE LOGICAL FILE      *
;*                                   *
;* ENTER:                            *
;*     CY =1 ,TRANSMIT CLOSE TO DEV- *
;*            ICE.                   *
;*     CY =0 ,ONLY REMOVE FROM KERNAL*
;*            TABLES.                *
;*                                   *
;*     THE LOGICAL FILE NUMBER OF THE*
;* FILE TO BE CLOSED IS PASSED IN .A.*
;* KEYBOARD, SCREEN, AND FILES NOT   *
;* OPEN PASS STRAIGHT THROUGH. TAPE  *
;* FILES OPEN FOR WRITE ARE CLOSED BY*
;* DUMPING THE LAST BUFFER AND       *
;* CONDITIONALLY WRITING AN END OF   *
;* TAPE BLOCK.SERIAL FILES ARE CLOSED*
;* BY SENDING A CLOSE FILE COMMAND IF*
;* A SECONDARY ADDRESS WAS SPECIFIED *
;* IN ITS OPEN COMMAND.              *
;*************************************
;
NCLOSE	PHP             ;SAVE CY FLAG
	JSR JLTLK       ;LOOK FILE UP
	BEQ JX110       ;WAS OPEN...CONTINUE
	PLP
	CLC             ;WAS NEVER OPEN...NO ERROR
	RTS
;
JX110	JSR JZ100       ;EXTRACT TABLE DATA
	PLP             ;RETRIEVE CY FLAG
	TXA             ;SAVE TABLE INDEX
	PHA
	BCC JX150       ;CLOSE OUT TABLE ENTRIES ONLY
;
	LDA FA          ;CHECK DEVICE NUMBER
	BEQ JX150       ;IS KEYBOARD...DONE
	CMP #3
	BEQ JX150       ;IS SCREEN...DONE
	BCS JX120       ;IS IEEE...PROCESS
	CMP #2          ;RS232?
	BNE JX115       ;NO...
;
; CLOSE RS-232 FILE
;
CLS232	LDA #0
	STA ACIA+CDR    ;DO A SOFT RESET
	BEQ JX150       ;JMP...REMOVE FILE
;
;
;CLOSE CASSETTE FILE
;
	.IFN SYSAGE <
JX115	LDA SA          ;WAS IT A TAPE READ?
	AND #$F
	BEQ JX150       ;YES
;
	JSR ZZZ         ;NO. . .IT IS WRITE
	LDA #0          ;END OF FILE CHARACTER
	JSR CASOUT      ;PUT IN END OF FILE
	JSR WBLK        ;EMPTY LAST BUFFER
	BCS JX200       ;STOP KEY PRESSED
;
	LDA SA
	CMP #$62        ;WRITE END OF TAPE BLOCK?
	BNE JX150       ;NO...
;
	LDA #EOT
	JSR TAPEH       ;WRITE END OF TAPE BLOCK
	JMP JX150
>
	.IFE SYSAGE <
JX115	PLA             ;CASSETTE NOW CLOSES THE CHANNEL...
	JSR JX151       ;BEFORE TRANSMITTING OUT THE FINAL DATA
	JSR XTAPE       ;GOTO TAPE INDIRECT
>
;
;CLOSE AN IEEE FILE
;
JX120	JSR CLSEI
;
;ENTRY TO REMOVE A GIVE LOGICAL FILE
;FROM TABLE OF LOGICAL, PRIMARY,
;AND SECONDARY ADDRESSES
;
JX150	PLA             ;GET TABLE INDEX OFF STACK
JX151	TAX             ;ENTRY FOR CASSETTE SPECIAL
	DEC LDTND
	CPX LDTND       ;IS DELETED FILE AT END?
	BEQ JX160       ;YES...DONE
;
;DELETE ENTRY IN MIDDLE BY MOVING
;LAST ENTRY TO THAT POSITION.
;
	LDY LDTND
	LDA LAT,Y
	STA LAT,X
	LDA FAT,Y
	STA FAT,X
	LDA SAT,Y
	STA SAT,X
JX160	CLC
JX170	RTS             ;CLOSE EXIT
	.IFN SYSAGE <
JX200	TAX             ;STOP KEY EXIT
	PLA
	TXA             ;RESTORE ERROR
	RTS
>
.SKI 5
;LOOKUP TABLIZED LOGICAL FILE DATA
;
LOOKUP	LDA #0
	STA STATUS
	TXA
JLTLK	LDX LDTND
JX600	DEX
	BMI LKUPS4
	CMP LAT,X
	BNE JX600
	CLC
	RTS
.SKI 5
;ROUTINE TO FETCH TABLE ENTRIES
;
JZ100	LDA LAT,X
	STA LA
	LDA FAT,X
	STA FA
	LDA SAT,X
	STA SA
JZ101	RTS
.SKI 5
;
;SA IS PASSED IN .Y
;ROUTINE LOOKS FOR MATCH IN TABLES
;CARRY SET IF NOT PRESENT
;CARRY CLEAR:
;.A=LA,.X=FA,.Y=SA
;
LKUPSA	TYA
	LDX LDTND
LKUPS2	DEX
	BMI LKUPS4
	CMP SAT,X
	BNE LKUPS2
	CLC
LKUPS3	JSR JZ100       ;GET TABLE DATA
	TAY
	LDA LA
	LDX FA
	RTS
LKUPS4	SEC
	RTS             ;NOT FOUND EXIT
.SKI 5
;LA IS PASSED IN .A
;ROUTINE LOOKS FOR MATCH IN TABLES
;CARRY SET IF NOT FOUND
;CARRY CLEAR:
;.A=LA,.X=FA,.Y=SA
;
LKUPLA	TAX
	JSR LOOKUP
	BCC LKUPS3
	RTS
.END
