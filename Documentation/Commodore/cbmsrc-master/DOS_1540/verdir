.PAGE 'VER-DIR'
; VALIDATE FILES WITH BAM
;  CREATE NEW BAM ACCORDING TO 
;  CONTENTS OF FILES ENTERED IN DIR
.SKIP
VERDIR
VALDAT
;VALIDATE IS SOFT-LOAD
	JSR SIMPRS      ;EXTRACT DRIVE #
	JSR INITDR
	LDA #$40
	STA WBAM
	JSR NEWMPV      ;SET NEW BAM
	LDA #0
	STA DELIND
	JSR SRCHST      ;SEARCH FOR FIRST FILE
	BNE VD25        ;FOUND ONE
.SKIP
VD10	LDA #0          ;SET DIRECTORY SECTORS...
	STA SECTOR      ;...IN BAM
	LDA DIRTRK
	STA TRACK
	JSR VMKBAM
	LDA #0
	STA WBAM
	JSR SCRBAM      ;WRITE OUT BAMS
	JMP ENDCMD
.SKIP
VD15	INY
	LDA (DIRBUF),Y
	PHA             ;SAVE TRACK
	INY
	LDA (DIRBUF),Y
	PHA             ;SAVE SECTOR
	LDY #19         ;GET SS TRACK
	LDA (DIRBUF),Y  ;IS THIS RELATIVE ?
	BEQ VD17        ;NO
	STA TRACK       ;YES - SAVE TRACK
	INY
	LDA (DIRBUF),Y  ;GET SS SECTOR
	STA SECTOR
	JSR VMKBAM      ;VALIDATE SS BY LINKS
VD17	PLA
	STA SECTOR      ;NOW DO DATA BLOCKS
	PLA
	STA TRACK
	JSR VMKBAM      ;SET BIT USED IN BAM
VD20	JSR SRRE        ;SEARCH FOR MORE
	BEQ VD10        ;NO MORE FILES
VD25
	LDY #0
	LDA (DIRBUF),Y
	BMI VD15
	JSR DELDIR      ;NOT CLOSED DELETE DIR
	JMP VD20
;
VMKBAM	;MARK BAM WITH FILE SECTORS
	JSR TSCHK
	JSR WUSED
	JSR OPNIRD
MRK2	LDA #0
	JSR SETPNT
	JSR GETBYT
	STA TRACK
	JSR GETBYT
	STA SECTOR
	LDA TRACK
	BNE MRK1
	JMP FRECHN
MRK1	JSR WUSED
	JSR NXTBUF
	JMP MRK2
;
.END
